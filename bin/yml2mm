#!/usr/bin/env perl
use 5.010;
use strict;
use warnings;
use autodie;
use Getopt::Std;
use YAML::XS qw(LoadFile);
use FindBin qw($Bin);

# YAML to ModuleManager converter
# CC-BY Paul Fenwick, 2014
# May also be used under the same terms as Perl itself.

# Don't have Perl? Try DWIM Perl!
# http://dwimperl.com/

# Editing this file? Make changes to the `yml2mm.lean` version, and
# compile the portable version with `fatten yml2mm.lean yml2mm`

my $DECORATION = "FOR[RP-0]";
my $DEFAULT_ENTRY_MULT = 20;

my %KNOWN_FIELDS;

@KNOWN_FIELDS{qw(
    cost
    entryCost
)} = ();

# Allow output file to be set.
my %opts = (o => "$Bin/../GameData/RP-0/Tree.cfg");
getopts('o:', \%opts);

warn "Writing output to $opts{o}\n";

if (@ARGV == 0) { @ARGV = "$Bin/../tree.yml" }

open(my $out_fh, ">", $opts{o});

say {$out_fh}
    "// THIS FILE IS AUTOMATICALLY GENERATED\n".
    "// DO NOT WRITE TO THIS FILE DIRECTLY\n".
    "// YOUR CHANGES WILL BE OVER-WRITTEN!\n".
    "// \n".
    "// Please edit `tree.yml` and then run `yml2mm` to regenerate\n"
;

my %seen_part;

foreach my $file (@ARGV) {
    my $yaml = LoadFile($file);

    foreach my $tech (sort keys %$yaml) {
        foreach my $part (sort keys %{ $yaml->{$tech}} ) {

            if ($seen_part{$part}++) {
                warn "WARNING: '$part' appears MULTIPLE TIMES in the tree\n";
            }

            my $changes = "\t%TechRequired = $tech\n";

            my $custom_fields = $yaml->{$tech}{$part};

            if (exists $custom_fields->{cost} and not exists $custom_fields->{entryCost}) {
                $custom_fields->{entryCost} = $custom_fields->{cost} * $DEFAULT_ENTRY_MULT;
            }

            # If there are changes listed for this part, copy them across.
            foreach my $field (sort keys %$custom_fields) {
                
                if (! exists $KNOWN_FIELDS{$field}) {
                    warn "WARNING: '$part' defines field '$field', are you sure?\n";
                }

                $changes .= "\t%$field = $custom_fields->{$field}\n";
            }
            if ($tech ne "ORPHANS") {
                if (exists $custom_fields->{cost}) {
                    $changes .= "\tRP0conf = true\n";
                }
                else {
                    $changes .= "\tRP0conf = false\n";
                }
            }

            say {$out_fh} "\@PART[$part]:$DECORATION\n{\n$changes}";
        }
    }
}
