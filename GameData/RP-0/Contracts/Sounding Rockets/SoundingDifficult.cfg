CONTRACT_TYPE
{
	name = SoundingRocketDifficult
	group = SoundingRockets
	
	title = Sounding Rocket (Difficult)
	
	description = Design, build and launch a sounding rocket with @/targetPayloadUnits.Print() units of payload to @/targetAltitudeKM.Print() km.
	genericDescription = Deliver a new payload to a specified altitude.  This contract will stretch your capabilites and enable harder contracts.
	
	synopsis = Launch a sounding rocket with @/targetPayloadUnits.Print() units of payload to @/targetAltitudeKM.Print() km.
	
	completedMessage = Congratulations on a successful launch! The rocket has delivered the payload.
	
	minExpiry = 1.0
	maxExpiry = 30.0
	deadline = 90
	cancellable = true
	declinable = true
	autoAccept = false
	
	targetBody = HomeWorld()
	
	maxCompletions = 0
	maxSimultaneous = 1
	prestige = Trivial
	
	// reward block
	advanceFunds = 400.0 + @/launchCost * 3
	rewardFunds = @advanceFunds + 1000
	failureFunds = @advanceFunds
	
	
	DATA
	{
		type = float
		soundingDifficulty = Max($RP0_SoundingDifficulty, 6000) 
	}
	
	DATA
	{
		type = float
		soundingMaxAlt = Max($RP0_SoundingMaxAltitudeKM, 100)
	}
	
	DATA
	{ 	// Force the player to try something 15% to 25% harder than before
		type = float
		maxDifficultyMultiplier = Random(1.15 , 1.25)
	}
	
	DATA
	{
		type = float
		maxDifficulty = Min( @maxDifficultyMultiplier * @soundingDifficulty , 660 * 6000 )
		title = Get New Target Difficulty
	}

	DATA
	{ //extend the max possible height to difficultymultiplier * previous max
		type = float
		maxRandAltitudeKM = Min(@soundingMaxAlt * @maxDifficultyMultiplier, @maxDifficulty / 70) 
		title = Max possible random altitude
	}
	
	
	DATA
	{
		type = float
		minRandAltitudeKM = Max( @maxDifficulty / 1060 , 100 )
		title = Minimum random altitude
	}
	
	DATA
	{
		//Pick where in the range of min to max altitudes we want to be, on a log scale
		type = float
		randMinAltMultiplier = Pow(10, Random(0 , Log( @maxRandAltitudeKM / @minRandAltitudeKM, 10))) 
	}
	
	DATA
	{ // pick a target altitude
		type = int
		targetAltitudeKM = int( Round(@minRandAltitudeKM * @randMinAltMultiplier, @maxRandAltitudeKM > 1000 ? 10 : 1) )
		title = Find our target altitude in kilometers
	}
	
	DATA
	{
		type = float
		newMaxAltitude = Max(@soundingMaxAlt,@targetAltitudeKM)
	}

	DATA
	{
		type = float
		targetPayload = Max( 10, Round(@maxDifficulty / @targetAltitudeKM , 1) - 60 )
		title = Deliver this many kg payload
	}
	
	DATA
	{
		type = float
		payloadUnitsPerKg = 1.0 /(1000.0 * Resource(SoundingPayload).Density())
	}
	
	DATA
	{
		type = int
		targetPayloadUnits = int( @targetPayload * @payloadUnitsPerKg )
		title = Deliver this many units of payload
	}
	
	DATA
	{ //Counts our techs and divides by 75 to determine a tech multiplier on costs
		type = float
		techVals = UnlockedTech().Count() /75
		title = reward decreasing multiplier for having more tech
	}
	
	DATA:NEEDS[TestFlight]
	{  //reliability factor for rewards - should be set if test flight is loaded
		type = float
		reliabiliyFactor = 1.25 - Min( 0.2, @techVals)
		title = exponent on launches for TF reliability
	}
	
	DATA:NEEDS[!TestFlight]
	{  //reliability factor for rewards if test flight is not installed
		type = float
		reliabiliyFactor = 1
		title = exponent on launches for TF reliability
	}
	
	DATA
	{ //reduces the reward as player tech improves (marginally) to account for better engines/tanks
		type = float
		techFactor = Max(0.5, 1 - @techVals)
		title = reward decreasing multiplier for having more tech
	
	}
	
	DATA
	{
		type = float
		payloadFactor =  Pow((60 + @/targetPayload) / 60 , @/reliabiliyFactor)
		title = payload factor in launch cost
	}
	
	DATA
	{ // Minimum possible launch cost, as determined by Maxsimal from play experience
		type = float
		launchCost =  11 + @/payloadFactor * @/techFactor * @/targetAltitudeKM / 3
		title = Rough minimum expected launch cost
	}
	
	REQUIREMENT
	{
		name = All of the below most be completed
		type = All
		
		REQUIREMENT
		{
			name = AltitudeRecord100k // Karman line
			type = AltitudeRecord
			minAltitude = 100000
			title = Must have reached 100 km
		}
		
		REQUIREMENT
		{
			name = AcceptContract
			type = AcceptContract
			contractType = SoundingRocketAltitude
			title = Have not accepted @contractType Contract
			invertRequirement = true
		}
		
		REQUIREMENT
		{
			name = AcceptContract
			type = AcceptContract
			contractType = SoundingRocketIntermediate
			title = Have not accepted @contractType Contract
			invertRequirement = true
		}
		
		REQUIREMENT
		{
			name = AcceptContract
			type = AcceptContract
			contractType = SoundingRocketEasy
			title = Have not accepted @contractType Contract
			invertRequirement = true
		}
	
		
		REQUIREMENT
		{
			name = CompleteSoundingDifficult
			type = CompleteContract

			contractType = SoundingRocketDifficult

			minCount = 0

			//complete before we can attempt again.
			//cooldownDuration = 4d
		}
		
		REQUIREMENT
		{
			name = CompleteSoundingIntermediate
			type = CompleteContract

			contractType = SoundingRocketIntermediate

			minCount = 0

			//complete before we can attempt again.
			//cooldownDuration = 4d
		}
		
		REQUIREMENT
		{
			name = CompleteSoundingEasy
			type = CompleteContract

			contractType = SoundingRocketEasy

			minCount = 0

			//complete before we can attempt again.
			//cooldownDuration = 4d
		}
				
		REQUIREMENT
		{
			name = CompleteSoundingAltitude
			type = CompleteContract

			contractType = SoundingRocketAltitude

			minCount = 0

			//complete before we can attempt again.
			//cooldownDuration = 4d
		}
		
	}
		
	
	BEHAVIOUR
    {//set the new difficulty
        name = SetMaxSoundingDifficulty
        type = Expression

        CONTRACT_COMPLETED_SUCCESS
        {
            RP0_SoundingDifficulty = @/maxDifficulty
        }
    }
	
	
	BEHAVIOUR
    { //reset the max height if it grew
        name = SetRP0_SoundingMaxAltitudeKM
        type = Expression

        CONTRACT_COMPLETED_SUCCESS
        {
            RP0_SoundingMaxAltitudeKM = @/newMaxAltitude
        }
    }
	
	PARAMETER
	{
		name = VesselGroup
		type = VesselParameterGroup
		
		title = Reach @/targetAltitudeKM.Print() km with @/targetPayloadUnits.Print() units of payload.
		
		PARAMETER
		{
			name = NewVessel
			type = NewVessel
			title = Launch a New Vessel
			hideChildren = true
		}
		PARAMETER 
		{
			name = Crewmembers
			type = HasCrew
			minCrew = 0
			maxCrew = 0
			title = Uncrewed
			hideChildren = true
		}
		PARAMETER
		{
			name = HasSoundingPayload
			type = HasResource
			resource = SoundingPayload
			minQuantity = @/targetPayloadUnits
			title = Have a SoundingPayload of at least @minQuantity units on the craft
		}
		PARAMETER
		{
			name = ReachAlt
			type = ReachState
			minAltitude = @/targetAltitudeKM * 1000
			completeInSequence = true
		}
	}
}
