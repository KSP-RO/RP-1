CONTRACT_TYPE
{
	name = AdvXplanesSSTOptionalSpeed
	group = AdvXPlanes

	title = Supersonic Transport Development (Speed) Optional
	
	tag = exclude_Supersonic

	description = <b>Program: Advanced X-Plane Research<br>Type: <color=red>CAPSTONE</color></b><br><br>Design, build, and fly a crewed passenger jet with room for 120 and maintain @VesselGroup/HoldSituation/minSpeed m/s in level flight for 2hrs, then return home safely. Optionally, landing back at the runway will award extra reputation. If playing from the Cape, the Space Shuttle runway provided by the RSS-CanaveralHD mod is also a valid landing target.<br><br><color=white><b>After this contract has been completed, the 'SST Development (High Speed) Optional' and 'SST Development (Capacity) Optional' contracts will become available.</b></color>
	genericDescription = Design, build, and fly a passenger jet aircraft to maintain a specific speed in level flight, then return home safely.

	synopsis = Fly a crewed jet aircraft to maintain @VesselGroup/HoldSituation/minSpeed m/s in level flight and hold, then return safely.

	completedMessage = Congratulations on a successful flight!
	
	sortKey = 4510

	deadline = 0
	cancellable = true
	declinable = true
	autoAccept = false
	minExpiry = 1
	maxExpiry = 1

	targetBody = HomeWorld()

	maxCompletions = 4
	maxSimultaneous = 1
	prestige = Trivial

	// ************ REWARDS ************
	prestige = Trivial       // 1.0x
	advanceFunds = 0
	rewardScience = 0
	rewardFunds = 0
	failureFunds = 0
	rewardReputation = (150 + @completions * 5) * @rewardFactor
	failureReputation = 0 // was @rewardReputation
	
	DATA
	{
		type = int
		antiGrindCompletion = $XPSS_Completion == 0 ? (UniversalTime() - @RP0:expectedDays_XPlanesSupersonicOptional * 86400) : $XPSS_Completion
	}
	
	DATA
	{
		type = int
		index = $RP0_XPSS_High_Difficulty
		completions = $RP0_XPSS_High_Difficulty
	}

	DATA
	{
		type = float
		elapsedDays = Round((UniversalTime() - @antiGrindCompletion) / 86400.0)
		rewardFactor = Log(Max(@elapsedDays / @RP0:expectedDays_XPlanesSupersonicOptional * 20 - 9, 1), 2) / 3.46
		rewardFactorPercent = Round(@rewardFactor * 100, 1)
	}
	
	// ************* REQUIREMENTS ****************

	REQUIREMENT
	{
		name = ProgramActive
		type = ProgramActive
		program = AdvXPlanes
	}

	REQUIREMENT
	{
		name = CompleteContract
		type = CompleteContract
		contractType = AdvXplanesSSTDevelopment
	}
	
	REQUIREMENT
	{
		name = AcceptContract
		type = AcceptContract
		tag = exclude_Supersonic
		invertRequirement = true
	}
	
	BEHAVIOUR
	{
		name = IncrementTheCount 
		type = Expression

		CONTRACT_OFFERED
		{
			
			XPSS_Completion = ($XPSS_Completion + 0) == 0 ? (UniversalTime() - @RP0:expectedDays_XPlanesSupersonicOptional * 86400) : ($XPSS_Completion + 0)
		
		}
		
		CONTRACT_COMPLETED_SUCCESS
		{
			XPSS_Completion = UniversalTime()
		}
	}
	
	BEHAVIOUR
	{
		name = SetSSDifficulty
		type = Expression


		CONTRACT_COMPLETED_SUCCESS
		{
			RP0_XPSS_High_Difficulty = $RP0_XPSS_High_Difficulty + 1
		}
	}
	
	DATA
	{
		type = List<float>
		minSpeedMPS = [ 850, 975, 1100, 1225] //Mach 2.5 -> Mach 3.7
	}
	

	PARAMETER
	{
		name = VesselGroup
		type = VesselParameterGroup
		title = Maintain between @HoldSituation/minSpeed m/s and @HoldSituation/maxSpeed m/s in level flight with a crewed jet aircraft.
		define = supersonicCraft
		dissassociateVesselsOnContractCompletion = true
		resetChildrenWhenVesselDestroyed = true
		
		PARAMETER
		{
			name = BuiltAtSPH
			type = VesselBuiltAt
			builtAt = SPH
		}

		PARAMETER
		{
			name = Has Crew
			type = HasCrew
			minCrew = 3 //Pilot, Copilot, Flight Engineer
			crewOnly = true
			title = Have at least 3 crewmember on board.
			hideChildren = true
		}
		
		PARAMETER
        {
            name = HasCapacity
            type = HasCrewCapacity
            minCapacity = 120
            title = Space for at least 120 passengers
            hideChildren = true
            disableOnStateChange = false
        }

		PARAMETER
		{
			name = NoRocket
			type = PartValidation
			title = Vessel is a jet (no rocket engines allowed)
			hideChildren = true
			NONE
			{
				partModule = ModuleEnginesRF
				partModule = ModuleEnginesAJEPropeller
			}
		}
		
		PARAMETER
		{
			name = HoldSituation
			type = ReachState
			minSpeed = @/minSpeedMPS.ElementAt(@/index)
			maxSpeed = @/minSpeedMPS.ElementAt(@/index) + 25
			minRateOfClimb = -50 // set a looser set of parameters, that way time warp can be used at higher settings and the length of the flight won't become monotonous.
			maxRateOfClimb = 50 // see above :)
			situation = FLYING
			
			title = Hold between @minSpeed m/s to @maxSpeed m/s in level flight.
			
			disableOnStateChange = true
			
			PARAMETER
			{
				name = Duration
				type = Duration
				duration = 120m
				preWaitText = Reach specified speed.
				waitingText = Testing highspeed flight
				completionText = Flight completed, you are cleared to land.
			}
		}
	}

	PARAMETER
	{
		name = ReturnVesselGroup
		type = VesselParameterGroup
		title = Land/splashdown anywhere
		vessel = supersonicCraft
		hideChildren = true

		PARAMETER
		{
			name = ReturnHome
			type = RP1ReturnHome
			title = Return home safely
			maxSpeed = 5
			hideChildren = true
			completeInSequence = true
		}
	}

	PARAMETER
	{
		name = OptVesselGroup
		type = VesselParameterGroup
		title = OPTIONAL: Land on the runway with a descent angle lower than 10 degrees
		rewardReputation = Round(@/rewardReputation * 0.3 + 0.4999, 1)
		optional = true
		vessel = supersonicCraft
		hideChildren = true

		PARAMETER
		{
			name = HorizontalLanding
			type = HorizontalLanding
			descentAngle = 10
			hideChildren = true
			completeInSequence = true
		}

		PARAMETER
		{
			name = ReturnHome
			type = RP1ReturnHome
			landAtFacility = Runway
			maxSpeed = 5
			hideChildren = true
			completeInSequence = true
		}
	}
}
